tinymce.PluginManager.add("upload",function(editor){var DOM=tinymce.DOM,doc=document,container=editor.getContainer(),buttonIcon,formAction=editor.settings.upload_action,formFileName=editor.settings.upload_file_name||"userfile",upload,isInit=false;function Upload(icon){this.icon=icon;this.button=DOM.getParents(this.icon,".mce-btn")[0];this.uid=DOM.uniqueId();this.createControl()}Upload.prototype={createControl:function(){var self=this,iframeId=self.uid+"_iframe",editorName=self.uid+"_editor",html='<form action="'+formAction+'" target="'+iframeId+'" method="post" accept-charset="utf-8" enctype="multipart/form-data"><input type="file" name="'+formFileName+'" value="" /><input type="hidden" name="editor" value="'+editorName+'" /></form><iframe id="'+iframeId+'" name="'+iframeId+'"></iframe>';window[editorName]=editor;var con=self.con=DOM.create("div",{id:self.uid},html);var buttonRect=DOM.getRect(self.button);DOM.setStyle(con,{width:buttonRect.w,height:buttonRect.h,opacity:0,overflow:"hidden",margin:0,padding:0,position:"absolute"});DOM.insertAfter(con,doc.body);self.form=DOM.select("form",con)[0];self.input=DOM.select("input",con)[0];DOM.setStyle(self.input,{width:buttonRect.w,height:buttonRect.h});DOM.bind(self.input,"change",function(){DOM.hide(con);DOM.addClass(self.icon,"mce-i-upload-disabled");self.form.submit()});self.adjustPos();var timer,adjustPos=function(){timer&&clearTimeout(timer);timer=setTimeout(function(){self.adjustPos()},200)};DOM.bind(window,"resize",adjustPos);DOM.bind(window,"scroll",adjustPos);DOM.bind(doc.body,"scroll",adjustPos);DOM.bind(doc.documentElement,"scroll",adjustPos)},adjustPos:function(){var self=this,buttonPos=DOM.getPos(self.button,doc.body);DOM.setStyle(self.con,{left:buttonPos.x,top:buttonPos.y})},finish:function(){var self=this;DOM.removeClass(self.icon,"mce-i-upload-disabled");DOM.show(self.con);self.adjustPos()}};editor.on("init",function(){buttonIcon=DOM.select(".mce-i-upload",container)[0]});editor.addButton("upload",{icon:"upload",tooltip:"Upload",onmouseover:function(){if(!isInit&&buttonIcon){isInit=true;upload=new Upload(buttonIcon)}}});return{finish:function(){upload.finish()}}});